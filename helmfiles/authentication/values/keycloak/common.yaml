tls:
  enabled: true
  autoGenerated: true
  usePem: true

production: true
replicaCount: 3
resources:
  requests:
    memory: 512Mi
    cpu: 100m
  limits:
    memory: 3Gi
    cpu: 750m

proxy: edge

logging:
  output: json

priorityClassName: system-cluster-critical

extraEnvVars:
- name: KC_HOSTNAME_URL
  value: https://auth.szymonrichert.pl/
- name: KC_HOSTNAME_ADMIN_URL
  value: https://auth.szymonrichert.pl/
- name: KEYCLOAK_ENABLE_HTTPS
  value: "false"
- name: PROMETHEUS_GROUPING_KEY_INSTANCE
  value: ENVVALUE:HOSTNAME


podLabels:
  application: keycloak

extraVolumes:
  - name: providers
    emptyDir: {}

extraVolumeMounts:
  - mountPath: /opt/bitnami/keycloak/providers/
    name: providers

initContainers:
  - name: init-copy-providers
    image: docker.io/bitnami/keycloak:24.0.4-debian-12-r0
    imagePullPolicy: IfNotPresent
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      privileged: false
      readOnlyRootFilesystem: true
      runAsGroup: 1001
      runAsNonRoot: true
      runAsUser: 1001
      seLinuxOptions: {}
      seccompProfile:
        type: RuntimeDefault
    command: [ bash ]
    args:
      - -cex
      - cp -R /opt/bitnami/keycloak/providers/ /providers/
    volumeMounts:
      - mountPath: /providers
        name: providers

  - name: koreui-download
    image: ghcr.io/szymonrychu/keycloak-providers:0.0.1
    imagePullPolicy: IfNotPresent
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      privileged: false
      readOnlyRootFilesystem: true
      runAsGroup: 1001
      runAsNonRoot: true
      runAsUser: 1001
      seLinuxOptions: {}
      seccompProfile:
        type: RuntimeDefault
    command: [ sh ]
    args:
      - -cex
      - cp -R /keycloak-providers/*.jar /providers/
    volumeMounts:
      - mountPath: /providers
        name: providers


affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: "kubernetes.io/hostname"
          operator: In
          values:
            - nuc1
            - nuc2
            - nuc3
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchExpressions:
        - key: application
          operator: In
          values:
          - keycloak
      topologyKey: "kubernetes.io/hostname"

service:
  type: ClusterIP
  sessionAffinity: ClientIP

ingress:
  enabled: true
  ingressClassName: nginx
  hostname: auth.szymonrichert.pl
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    kubernetes.io/tls-acme: "true"
    "nginx.ingress.kubernetes.io/proxy-buffer-size": "128k"
  tls: true

pdb:
  create: true

metrics:
  enabled: true
  serviceMonitor:
    enabled: true
  prometheusRule:
    enabled: true

externalDatabase:
  host: keycloak-database-cluster-rw
  port: 5432
  user: keycloak
  database: keycloak
  existingSecret: keycloak-database-cluster-app
  existingSecretPasswordKey: password

postgresql:
  enabled: false

cache:
  enabled: true
