{{ ansible_managed | comment }}

datacenter = "{{ consul_dc }}"
data_dir = "{{ consul_root_dir }}"
encrypt = "{{ consul_key.content | b64decode | trim }}"
verify_incoming = true
verify_outgoing = true
verify_server_hostname = true

ca_file = "{{ consul_root_dir }}/consul-agent-ca.pem"
cert_file = "{{ consul_root_dir }}/{{ consul_dc }}-server-{{ consul_domain }}-0.pem"
key_file = "{{ consul_root_dir }}/{{ consul_dc }}-server-{{ consul_domain }}-0-key.pem"

auto_encrypt {
  allow_tls = true
}

bind_addr = "{{ hostvars[inventory_hostname][_ansible_node_interface]['ipv4']['address'] }}"

retry_join = [{% for host in consul_master_nodes %}{% if host != inventory_hostname %}"{{ hostvars[host][_ansible_node_interface]['ipv4']['address'] }}"{% if not loop.last %}, {% endif %}{% endif %}{% endfor %}]

acl {
  enabled = true
  default_policy = "allow"
  enable_token_persistence = true
}

server = true
bootstrap_expect = 3